<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <title>Welcome to the CryptoScreener !</title>
	<link rel="stylesheet" type="text/css" href="./libs/styleScreener.css">
	<script type="text/javascript" src="./libs/initScreener.js"></script>
	<script type="text/javascript" src="./libs/configScreener.js"></script>
	<script type="text/javascript" src="./libs/web3.min.js"></script>
	<script type="text/javascript" src="./libs/libsScreener.js"></script>
	<script type="text/javascript" src="./libs/walletsScreener.js"></script>
	<!-- <script type="text/javascript" src="./libs/human_standard_token_abi.js"></script> -->
	<script type="text/javascript">
		if(infura_KEY != "") {
			window.addEventListener('load', function () {
				if (typeof web3 !== 'undefined') {
				console.log('Web3 Detected! ' + web3.currentProvider.constructor.name)
				window.web3 = new Web3(web3.currentProvider);
				} else {
				console.log('No Web3 Detected... using HTTP Provider')
				window.web3 = new Web3(new Web3.providers.HttpProvider("https://mainnet.infura.io/"+infura_KEY));
				}
			})
		}
	</script>
</head>
<body>
	<div id="header" class="inline">
		<div id="cmc_mc" class="column">M.Cap: <span id="gl_MC"></span> <span id="curr_symb1"></span></div>
		<div id="cmc_vol" class="column">24h Vol: <span id="gl_Vol"></span> <span id="curr_symb2"></span></div>
		<div id="cmc_dom" class="column">BTC Dom: <span id="gl_BTCdom"></span> %</div>
		<div class="column">Bal: <span id="wallet_Balance"></span> <span id="curr_symb3"></span>  <span id="gain_loss"></span>|
			<select id="currencyChoice" onchange="choiceCurrency(this.value)">
				<option selected="selected" value="EUR">EUR</option>
				<option value="USD">USD</option>
				<option value="BTC">BTC</option>
				<option value="ETH">ETH</option>
				<option value="NEO">NEO</option>
			</select>
		</div>
		<div class="column">
			<span id="lastupdate" class="dateheure"></span> |
			1d:<input id="oneDayGraph" name="OneDay" value="oneday" type="checkbox" onchange="changeDayGraph(this)" /> |
			<!-- 7d:<input id="sevenDayGraph" name="SevenDays" value="sevenday"type="checkbox" onchange="changeDayGraph(this)" /> | -->
<!--			@<input id="onlineMode" name="onlineMode" value="true"type="checkbox" onchange="changeOnlineMode(this)" /> -->
			<select id="sortChoice" onchange="sortChoice(this.value)">
				<option value="Rank">Rank</option>
				<option value="Balance">Balance</option>
				<option selected="selected" value="24H">%24H</option>
			</select>
		</div>
	</div>
	<div id="dvTableCoins"></div>
	<hr/>
	<div id="dvTableTokens"></div>
	<hr/>
	<div id="dvTableTokensFD"></div>
	<hr/>
	<div id="dvTableUnknownTokens"></div>
	<hr/>
	<!-- <input type="button" value="Refresh Table" onclick="refreshTables()" />
	<button type="button" onClick="getBalance();">Get Balance</button> -->
	<div id="output"></div>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<script>
	var table = $("#mytable");
	var currency = $("#currencyChoice").val();
	var currencySym = "€";
	var decimals = 5;
	var gain_loss = 0;
	var indexOrder = "DESC";
	var indexItem = 2;
	
	$(document).ready(startApp());

	function startApp() {
		initScreenerConfiguration();
		
		//loadIDEX_Tokens();
		
		
		console.log("Online Mode: "+configScreener.onlineMode);
		// if(configScreener.onlineMode) {
			lstAllTokensCMC = loadCMC_Tokens();
		// }
		// else {
			// lstAllTokensCMC = readCMC_Tokens();
		// }
		
		if(configScreener.otherWallet) {
			loadWallet_online();
		}
		
		GenerateCoinsInfos();
		
		if(configScreener.localWallet) {
			readTokensWalletFile(configScreener.walletName);
		}
		//verifyForkDelta();
		
		// Charge les infos du marché Global de CoinMarketCap (CCC)
		info_CoinMarketCap_Global();

		if(configScreener.onlineMode) {
			//////////////////////////////////////////////////////////////////
			// MODE ON LINE /////////////////////////////////////////////////
			generateTable(lstCoins, "dvTableCoins");
			generateTable(lstTokens, "dvTableTokens");
			var newCells = GenerateTokensInfos();
			//////////////////////////////////////////////////////////////////
		}
		else {
			//////////////////////////////////////////////////////////////////
			// MODE OFF LINE /////////////////////////////////////////////////
			generateTable_offline(smallListCoins, "dvTableCoins");
			GenerateCoinsInfos_offline();
			generateTable_offline(smallListTokens, "dvTableTokens");
			GenerateTokensInfos_offline();
			generateTable_offline(lstForkDeltaTokens, "dvTableTokensFD");
			GenerateForkDeltaTokensInfos_offline();
			// generateTable_offline(unkTokens, "dvTableUnknownTokens");
			// GenerateUnknownTokensInfos_offline();
			//////////////////////////////////////////////////////////////////
		}
		changeWalletBalance();
		$("#wallet_Balance").html(walletBalance.toFixed(2));
		$("#gain_loss").html(gain_loss.toFixed(2));
		if(gain_loss > 0) {
			$("#gain_loss").css('color', 'green');
		}
		else {
			$("#gain_loss").css('color', 'red');
		}
		$("#oneDayGraph").prop('checked', true);
		
		// console.log(unkTokens);
		
	}

	function changeOnlineMode(choice) {
		if(choice.value == "true") {
			if(choice.checked) {
				configScreener.onlineMode = true;
				localStorage.setItem('cs_configuration', JSON.stringify(configScreener));
			}
			else {
				configScreener.onlineMode = false;
				localStorage.setItem('cs_configuration', JSON.stringify(configScreener));
			}
			refreshTables();
		}
	}
	
	function readTokensWalletFile(walletFile) {
		var listAllTokens = [];
		$.ajax({
			type: "GET",
			url: walletFile,
			dataType: "text",
			async: false,
			success: function(data) { 
				listAllTokens = processData(data);
				var tokenName;
				$.each(listAllTokens, function(key, values) {
					$.each(values, function(header, value) {
						var splitLine = value.split(":");
						if(splitLine[0] == "Token") {
							tokenName = splitLine[1];
							if(tokenName.indexOf('(') > -1) {
								tokenName = tokenName.substring(0, tokenName.indexOf('('));
							}
							var nbTokens = values[6].split(":");
							var contractAddress = values[9].split(":");
							if((lstAllTokensCMC.filter(p => p.symbol == tokenName)).length > 0) {
								var indexToken = lstAllTokensCMC.findIndex(p => p.symbol == tokenName);
								var token = lstAllTokensCMC.filter(p => p.symbol == tokenName);
								var totalTokens = parseFloat(nbTokens[1]) * token[0].price_eur;
								if((token[0].id).toUpperCase() == "ETHEREUM") {
									lstCoins.push([(token[0].id).toUpperCase(), "coinmarketcap", indexToken + 1, "", parseFloat(nbTokens[1]), ""]);
								}
								else {
									if(!exceptTokens.includes()) {
										lstTokens.push([(token[0].id).toUpperCase(), "coinmarketcap", indexToken + 1, "", parseFloat(nbTokens[1]), ""]);
									}
								}
								if((!exceptContract.includes(contractAddress[1])) && (!exceptTokens.includes(token[0].symbol))) {
									if(contractAddress[1] != "Not a token") {
										lstGoodTokens[token[0].rank] = [token[0].id, token[0].symbol, token[0].rank, token[0].price_btc, token[0]["percent_change_24h"], token[0].market_cap_usd, token[0]["24h_volume_usd"], parseFloat(nbTokens[1]), token[0].name, token[0].price_usd, token[0].price_eur, contractAddress[1]];
										smallListTokens.push([(token[0].id).toUpperCase(), parseInt(token[0].rank), parseFloat(token[0]["percent_change_24h"]), totalTokens]);
									}
									else {
										lstGoodCoins[token[0].rank] = [token[0].id, token[0].symbol, token[0].rank, token[0].price_btc, token[0]["percent_change_24h"], token[0].market_cap_usd, token[0]["24h_volume_usd"], parseFloat(nbTokens[1]), token[0].name, token[0].price_usd, token[0].price_eur, contractAddress[1]];
										smallListCoins.push([(token[0].id).toUpperCase(), parseInt(token[0].rank), parseFloat(token[0]["percent_change_24h"]), totalTokens]);
									}
									// console.log(token);
								}
							}
							else {
								unkTokens.push([tokenName, tokenName, 0, 0, 0, 0, nbTokens[1], contractAddress[1]]);
							}
						}
					});
				});
			}
		});
	}

	function filter_TokensWalletFileCMC() {
		$.each(listAllTokens, function(key, value) {
			var priceToken = 0;
			var tokenSymbol = value[0];
			
			for(var i = 0; i < lstAllTokensCMC.length; i++)
			{
				if(lstAllTokensCMC[i].symbol == tokenSymbol)
				{
					console.log(lstAllTokensCMC[i].name);
				}
			}
		});
	}

	function readCMC_Tokens() {
		var listAllTokens = [];
		var dateSync = new Date(JSON.parse(localStorage.getItem('date_cmc_tokens')));
		var diff = new Date(new Date() - dateSync);
		var days = diff.getTime()/1000/60;
		$.ajax({
			type: "GET",
			url: "./cmc.json",
			dataType: "json",
			async: false,
			success: function(data) { 
				listAllTokens = data;
			}
		});
		return listAllTokens;
	}

	function loadCMC_Tokens() {
		var listAllTokens = []; 
		if (localStorage.getItem("cs_lastvisit") === null) {
			localStorage.setItem('cs_lastvisit', JSON.stringify(new Date()));
			// console.log("Init Last Visit");
		}
		else {
			var lastvisit = new Date(JSON.parse(localStorage.getItem('cs_lastvisit')));
			var diff = new Date(new Date() - lastvisit);
			var minutes = diff.getTime()/1000/60;
			if(minutes >= 15) {
				console.log("Load CMC Tokens Infos");
				$.ajax({
					url: cmc_urlAPI+'?limit=0&convert=EUR',
					dataType: 'json',
					async: false,
					success: function(data) {
						listAllTokens = data;
					}
				});
				localStorage.setItem('cs_CMCtokens', JSON.stringify(listAllTokens));
			}
			else {
				console.log("Read CMC Tokens Infos");
				listAllTokens = JSON.parse(localStorage.getItem('cs_CMCtokens'));
				// console.log(listAllTokens);
			}

		}
		return listAllTokens;
	}

	function loadIDEX_Tokens() {
		var listAllTokens = []; 
		$.ajax({
			method: 'POST',
			url: 'https://api.idex.market/returnTicker',
			json: {
				market: 'ETH_SAN'
			},
			dataType: 'json',
			async: false,
			success: function(data) {
				listAllTokens = JSON.parse(data);
			}
		});
		console.log(listAllTokens);
		return listAllTokens;
	}
	
	function refreshTables() {
		info_CoinMarketCap_Global();
		if(configScreener.onlineMode) {
			//////////////////////////////////////////////////////////////////
			// MODE ON LINE /////////////////////////////////////////////////
			// lstAllTokensCMC = loadCMC_Tokens();
			// loadWallet_online();
			// generateTable(lstCoins, "dvTableCoins");
			// var newCells = GenerateCoinsInfos();
			// var newCells = GenerateCoinsInfos();
			// var newCells = GenerateTokensInfos();
			//////////////////////////////////////////////////////////////////
		}
		else {
			//////////////////////////////////////////////////////////////////
			// MODE OFF LINE /////////////////////////////////////////////////
			generateTable_offline(smallListCoins, "dvTableCoins");
			GenerateCoinsInfos_offline();
			generateTable_offline(smallListTokens, "dvTableTokens");
			GenerateTokensInfos_offline();
			// GenerateCoinsInfos_offline();
			// GenerateTokensInfos_offline();
			//////////////////////////////////////////////////////////////////
		}
	}

	function changeDayGraph(choice) {
		if(choice.value == "oneday") {
			if(choice.checked) {
				$(".sparkline1d").css("display", "inline");
			}
			else {
				$(".sparkline1d").css("display", "none");
			}
		}
		if(choice.value == "sevenday") {
			if(choice.checked) {
				$(".sparkline7d").css("display", "inline");
			}
			else {
				$(".sparkline7d").css("display", "none");
			}
		}
	}

	function choiceCurrency(type) {
		if(type == "EUR") {
			currency = "EUR";
			currencySym = "€";
			decimals = 5;
		}
		if(type == "USD"){
			currency = "USD";
			currencySym = "$";
			decimals = 5;
		}
		if(type == "BTC"){
			currency = "BTC";
			currencySym = "B";
			decimals = 8;
		}
		if(type == "ETH"){
			currency = "ETH";
			currencySym = "E";
			decimals = 7;
		}
		if(type == "LTC"){
			currency = "LTC";
			currencySym = "L";
			decimals = 7;
		}
		if(type == "NEO"){
			currency = "NEO";
			currencySym = "N";
			decimals = 7;
		}
		
		info_CoinMarketCap_Global();
		var newCells = GenerateTokensInfos();
	}

	function tokenInfo_CoinMarketCap(token, idImage, nbTokens, convert) {
		//currency = $("#currencyChoice").val();
		var tokenInfo = new Array();
		var pump = "";
		var curr_convert = "";
		var priceToken = 0;
		if(convert == "") { curr_convert = currency; }
		else { curr_convert = convert.toUpperCase(); }

		var jqxhr = $.getJSON(cmc_urlAPI+token+'/?convert='+curr_convert);
		jqxhr.done(function(data) {
			if(token == "BITCOIN") { 
				priceBTC = (currency == "EUR" ? parseFloat(data[0].price_eur) : parseFloat(data[0].price_usd));
			}
			if(token == "ETHEREUM") { 
				priceETH = (currency == "EUR" ? parseFloat(data[0].price_eur) : parseFloat(data[0].price_usd));
			}
			
			priceToken = calculPriceToken(data, curr_convert.toUpperCase());
			
			verifyBump_Token(data[0]);
			
			var priceWallet = priceToken * nbTokens;
			if(data[0]["percent_change_24h"] > 0) { 
				colorvar = "percent_change_green" 
				colorName = "tokename_green";
			}
			else { 
				colorvar = "percent_change_red" 
				colorName = "tokename_red";
			}
			if(data[0]["percent_change_24h"] > 15 && data[0]["percent_change_24h"] < 30) { 
				pump = "pump"; 
			}
			else if(data[0]["percent_change_24h"] >= 30) { colorName = ""; pump = "bigpump"; }
			else if(data[0]["percent_change_24h"] < -15 && data[0]["percent_change_24h"] > -40) { pump = "pump"; }
			else if(data[0]["percent_change_24h"] <= -40) {  colorName = ""; pump = "bigdump"; }
			
			if(data[0].name.length > 10) { 
				if(data[0].symbol.length >3) { lenTokenName = 5; }
				else { lenTokenName = 8; }
				affTokenName = data[0].name.substring(0,lenTokenName) + "..."; 
			}
			else { affTokenName = data[0].name; }
			var tokenInfo = "<div class='cellule'>"+
								"<div class='tokenicon' id=icon><img src='"+spootnik_urlStatic32IMG+data[0].id+".png' /></div>"+
								"<div class='tokeninfo' id=text>"+
									"<div id='"+colorName+"' class='"+pump+"'>"+affTokenName+" ("+data[0].symbol+")</div>"+
									"<div id='token_infos' class='"+colorvar+"'>"+
										"<span id='price_eur'>"+priceToken.toFixed(decimals)+" "+currencySym+"</span> <span id='percent_change'>("+data[0]["percent_change_24h"]+"%)</span>"+
									"</div>"+
									"<div id='wallet_infos' class=''>"+
									"<span id='price_eur'>"+priceWallet.toFixed(decimals)+" "+currencySym+"</span> <span id='percent_change'>("+nbTokens+data[0].symbol+")</span>"+
									"</div>"+
								"</div>"+
								
			
							"</div>"+
			"<div class='rowInfos'>"+
			"<div id='rank' class='Column'>RANK<br>"+data[0].rank+"</div><div id='market_cap' class='Column'>MARKET CAP<br>$"+nFormatter(data[0].market_cap_usd, 2)+"</div><div id='volume' class='Column'>VOLUME (24H)<br>$"+nFormatter(data[0]["24h_volume_usd"], 2)+"</div>"+
			"</div>"+
			"<div class='sparkline1d'>"+
			// "<div id='sparktext'>1d:</div><div id='sparkImg1d' class='Column'><img class='sparkline' src='"+cmc_sparkLine1d+idImage+".png' /></div>"+
			"</div>"+
			"<div class='sparkline7d'>"+
			// "<div id='sparktext'>7d:</div><div id='sparkImg7d' class='Column'><img class='sparkline' src='"+cmc_sparkLine7d+idImage+".png' /></div>"+
			"</div>"+
			"<div class='rowBlank'>"+
			"</div>";		
			$("#"+token).html(tokenInfo);
		});
	}

	function tokenInfo_CoinMarketCap_offline(tokenName, token) {
		//currency = $("#currencyChoice").val();
		var tokenInfo = new Array();
		var pump = "";
		var curr_convert = "";
		var priceToken = 0;
		var token_color= "";
		var fontColor = "";
		var headerColor = "#ecece2";
		priceToken = calculPriceToken(token, "EUR");
// console.log(token);
		verifyBump_Token(token[0]);
		
		var priceWallet = token[10] * token[7];
		if(token[4] > 0) { 
			colorvar = "percent_change_green" 
			colorName = "tokename_green";
		}
		else { 
			colorvar = "percent_change_red" 
			colorName = "tokename_red";
		}
		if(token[4] > 15 && token[4] < 30) { 
			pump = "pump"; 
		}
		else if(token[4] >= 30 && token[4] < 50) { colorName = ""; pump = "bigpump"; }
		else if(token[4] >= 50) { 
			colorName = ""; 
			headerColor = "green"; 
			pump = "megapump"; 
			fontColor = "_white";
		}
		else if(token[4] < -15 && token[4] > -25) { pump = "pump"; }
		else if(token[4] <= -25 && token[4] > -45) {  colorName = ""; pump = "bigdump"; }
		else if(token[4] <= -45) {  
			colorName = ""; 
			headerColor = "red"; 
			pump = "megadump"; 
			fontColor = "_white";
		}
		
		walletBalance += priceWallet;
		
		if(token[11].substring(0,2) == "0x") {
			token_color = "circle_eth";
		}
		else if(token[11] == "NEO") {
			token_color = "circle_neo";
		}
		
		var nbToken = token[7];
		if(isInt(nbToken)) {
			nbToken = parseInt(token[7]);
		}
		else {
			nbToken = parseFloat(token[7]).toFixed(2);
		}
		
		if(token[8].length > 10) { 
			if(token[1].length >3) { lenTokenName = 5; }
			else { lenTokenName = 8; }
			affTokenName = token[8].substring(0,lenTokenName) + "...(" + token[1] + ")"; 
		}
		else { affTokenName = token[8] + " (" + token[1] + ")"; }
		// console.log(tokenName + " : " +affTokenName);
		var tokenInfo = "<div class='cellule'>"+
							"<div class='tokenicon' id=icon><img src='"+spootnik_urlStatic32IMG+token[0]+".png' /></div>"+
							"<div class='tokeninfo' id=text>"+
								"<div id='"+colorName+"' class='"+pump+"'><a href='https://coinmarketcap.com/currencies/"+ tokenName +"/' target='_blank'>"+affTokenName+"</a></div>"+
								"<div id='token_infos' class='"+colorvar+"'>"+
									"<span id='price_eur"+fontColor+"'>"+priceToken.toFixed(decimals)+" "+currencySym+"</span> <span id='percent_change"+fontColor+"'>("+token[4]+"%)</span>"+
								"</div>"+
								"<div id='wallet_infos' class=''>"+
								"<span id='price_eur"+fontColor+"'>"+priceWallet.toFixed(2)+" "+currencySym+"</span> <span id='percent_change"+fontColor+"'>("+nbToken+token[1]+")</span>"+
								"</div>"+
								"<div id='token_type' class=''>"+
								"<span id='token_ico' class='"+ token_color + "'></span>"+
								"</div>"+
							"</div>"+
							
		
						"</div>"+
		"<div class='rowInfos'>"+
		"<div id='rank' class='Column'>RANK<br>"+token[2]+"</div><div id='market_cap' class='Column'>MARKET CAP<br>$"+nFormatter(token[5], 2)+"</div><div id='volume' class='Column'>VOLUME (24H)<br>$"+nFormatter(token[6], 2)+"</div>"+
		"</div>"+
		"<div class='sparkline1d'>"+
		// "<div id='sparktext'>1d:</div><div id='sparkImg1d' class='Column'><img class='sparkline' src='"+cmc_sparkLine1d+idImage+".png' /></div>"+
		"</div>"+
		"<div class='sparkline7d'>"+
		// "<div id='sparktext'>7d:</div><div id='sparkImg7d' class='Column'><img class='sparkline' src='"+cmc_sparkLine7d+idImage+".png' /></div>"+
		"</div>"+
		"<div class='rowBlank'>"+
		"</div>";		
		$("#"+tokenName).html(tokenInfo);
		$("#"+tokenName).css("background-color", headerColor);
	}

	function tokenInfo_ForkDelta_offline(tokenName, token) {
		//currency = $("#currencyChoice").val();
		var tokenInfo = new Array();
		var pump = "";
		var curr_convert = "";
		var priceToken = 0;
		priceToken = calculPriceToken(token, "EUR");
// console.log(token);
		verifyBump_Token(token[0]);
		
		var priceWallet = token[10] * token[7];
		if(token[4] > 0) { 
			colorvar = "percent_change_green" 
			colorName = "tokename_green";
		}
		else { 
			colorvar = "percent_change_red" 
			colorName = "tokename_red";
		}
		if(token[4] > 15 && token[4] < 30) { 
			pump = "pump"; 
		}
		else if(token[4] >= 30) { colorName = ""; pump = "bigpump"; }
		else if(token[4] < -15 && token[4] > -40) { pump = "pump"; }
		else if(token[4] <= -40) {  colorName = ""; pump = "bigdump"; }

		walletBalance += priceWallet;
		
		if(token[8].length > 10) { 
			if(token[1].length >3) { lenTokenName = 5; }
			else { lenTokenName = 8; }
			affTokenName = token[8].substring(0,lenTokenName) + "..."; 
		}
		else { affTokenName = token[8]; }
		// console.log(token);
		var tokenInfo = "<div class='cellule'>"+
							"<div class='tokenicon' id=icon><img src='' /></div>"+
							"<div class='tokeninfo' id=text>"+
								"<div id='"+colorName+"' class='"+pump+"'>"+affTokenName+" ("+token[1]+")</div>"+
								"<div id='token_infos' class='"+colorvar+"'>"+
									"<span id='price_eur'>L: "+parseFloat(token[4]).toFixed(13)+" E</span><br /><span id='percent_change'>A: "+parseFloat(token[5]).toFixed(13)+" E</span><br /><span id='percent_change'>B: "+parseFloat(token[10]).toFixed(13)+" E</span>"+
								"</div>"+
								"<div id='wallet_infos' class=''>"+
								"<span id='price_eur'>"+priceWallet.toFixed(2)+" "+currencySym+"</span> <span id='percent_change'>("+token[7]+token[1]+")</span>"+
								"</div>"+
							"</div>"+
							
		
						"</div>"+
		"<div class='rowInfos'>"+
		"<div id='rank' class='Column'>RANK<br></div><div id='market_cap' class='Column'>MARKET CAP<br>$"+nFormatter(token[2], 2)+"</div><div id='volume' class='Column'>VOLUME (24H)<br>$"+nFormatter(token[3], 2)+"</div>"+
		"</div>"+
		"<div class='sparkline1d'>"+
		// "<div id='sparktext'>1d:</div><div id='sparkImg1d' class='Column'><img class='sparkline' src='"+cmc_sparkLine1d+idImage+".png' /></div>"+
		"</div>"+
		"<div class='sparkline7d'>"+
		// "<div id='sparktext'>7d:</div><div id='sparkImg7d' class='Column'><img class='sparkline' src='"+cmc_sparkLine7d+idImage+".png' /></div>"+
		"</div>"+
		"<div class='rowBlank'>"+
		"</div>";		
		$("#"+tokenName).html(tokenInfo);
	}

	function tokenInfo_Unknown_offline(tokenName, token) {
		//currency = $("#currencyChoice").val();
		var tokenInfo = new Array();
		var pump = "";
		var curr_convert = "";
		var priceToken = 0;
		priceToken = calculPriceToken(token, "EUR");
// console.log(token);
		verifyBump_Token(token[0]);
		
		// var priceWallet = token[10] * token[7];
		// if(token[4] > 0) { 
			// colorvar = "percent_change_green" 
			// colorName = "tokename_green";
		// }
		// else { 
			// colorvar = "percent_change_red" 
			// colorName = "tokename_red";
		// }
		// if(token[4] > 15 && token[4] < 30) { 
			// pump = "pump"; 
		// }
		// else if(token[4] >= 30) { colorName = ""; pump = "bigpump"; }
		// else if(token[4] < -15 && token[4] > -40) { pump = "pump"; }
		// else if(token[4] <= -40) {  colorName = ""; pump = "bigdump"; }

		// walletBalance += priceWallet;
		
		// if(token[8].length > 10) { 
			// if(token[1].length >3) { lenTokenName = 5; }
			// else { lenTokenName = 8; }
			// affTokenName = token[8].substring(0,lenTokenName) + "..."; 
		// }
		// else { affTokenName = token[8]; }
		// console.log(token);
		var tokenInfo = "<div class='cellule'>"+
							"<div class='tokenicon' id=icon><img src='' /></div>"+
							"<div class='tokeninfo' id=text>"+
								"<div id='"+colorName+"' class='"+pump+"'>"+affTokenName+" ("+token[1]+")</div>"+
								"<div id='token_infos' class='"+colorvar+"'>"+
									"<span id='price_eur'>L: "+parseFloat(token[4]).toFixed(13)+" E</span><br /><span id='percent_change'>A: "+parseFloat(token[5]).toFixed(13)+" E</span><br /><span id='percent_change'>B: "+parseFloat(token[10]).toFixed(13)+" E</span>"+
								"</div>"+
								"<div id='wallet_infos' class=''>"+
								"<span id='price_eur'> "+currencySym+"</span> <span id='percent_change'>("+token[7]+token[1]+")</span>"+
								"</div>"+
							"</div>"+
							
		
						"</div>"+
		"<div class='rowInfos'>"+
		"<div id='rank' class='Column'>RANK<br></div><div id='market_cap' class='Column'>MARKET CAP<br>$"+nFormatter(token[2], 2)+"</div><div id='volume' class='Column'>VOLUME (24H)<br>$"+nFormatter(token[3], 2)+"</div>"+
		"</div>"+
		"<div class='sparkline1d'>"+
		// "<div id='sparktext'>1d:</div><div id='sparkImg1d' class='Column'><img class='sparkline' src='"+cmc_sparkLine1d+idImage+".png' /></div>"+
		"</div>"+
		"<div class='sparkline7d'>"+
		// "<div id='sparktext'>7d:</div><div id='sparkImg7d' class='Column'><img class='sparkline' src='"+cmc_sparkLine7d+idImage+".png' /></div>"+
		"</div>"+
		"<div class='rowBlank'>"+
		"</div>";		
		$("#"+tokenName).html(tokenInfo);
	}
	
	function tokenInfo_IDEXmarket(token, idImage, nbTokens, convert) {
		$.post('https://api.idex.market/returnTicker',
		{
			json: {
				market: 'ETH_FDZ'
			}
			}, function(err, resp, body) {
			console.log(body);
		});
	}

	function info_CoinMarketCap_Global() {
		//console.log(cmc_urlAPIinformation+currency);
		var dateConvert = new Date();
		if (localStorage.getItem("cs_lastvisit") === null) {
			localStorage.setItem('cs_lastvisit', JSON.stringify(new Date()));
			// console.log("Init Last Visit");
		}
		else {
			var cmcInfos;
			var lastvisit = new Date(JSON.parse(localStorage.getItem('cs_lastvisit')));
			var diff = new Date(new Date() - lastvisit);
			var minutes = diff.getTime()/1000/60;
			if(minutes >= 30) {
				console.log("Load CMC General Infos");
				// console.log("Get Last Visit : "+lastvisit + " ("+parseInt(minutes)+"min)");
				var jqxhr = $.getJSON(cmc_urlAPIinformation+currency);
				jqxhr.done(function(data) {
					cmcInfos = data;
					dateConvert = convertDate(cmcInfos.last_updated);
					// console.log(data);
					$("#lastupdate").html(dateConvert);
					if(currency == "EUR") {
						$("#gl_MC").html(nFormatter(cmcInfos.total_market_cap_eur, 4));
						$("#gl_Vol").html(nFormatter(cmcInfos.total_24h_volume_eur, 4));
					}
					if(currency == "USD"){
						$("#gl_MC").html(nFormatter(cmcInfos.total_market_cap_usd, 4));
						$("#gl_Vol").html(nFormatter(cmcInfos.total_24h_volume_usd, 4));
					}
					if(currency == "ETH"){
						$("#gl_MC").html(nFormatter(cmcInfos.total_market_cap_eth, 4));
						$("#gl_Vol").html(nFormatter(cmcInfos.total_24h_volume_eth, 4));
					}
					if(currency == "LTC"){
						$("#gl_MC").html(nFormatter(cmcInfos.total_market_cap_ltc, 4));
						$("#gl_Vol").html(nFormatter(cmcInfos.total_24h_volume_ltc, 4));
					}
					if(currency == "NEO"){
						$("#gl_MC").html(nFormatter(cmcInfos.total_market_cap_neo, 4));
						$("#gl_Vol").html(nFormatter(cmcInfos.total_24h_volume_neo, 4));
					}
					
					$("#curr_symb1").html(currencySym);
					$("#curr_symb2").html(currencySym);
					$("#curr_symb3").html(currencySym);
					
					if(cmcInfos.bitcoin_percentage_of_market_cap > 50) { $("#gl_BTCdom").css("color", "red"); }
					else { $("#gl_BTCdom").css("color", "green"); }
					
					$("#gl_BTCdom").html(cmcInfos.bitcoin_percentage_of_market_cap);
					
					localStorage.setItem('cs_lastvisit', JSON.stringify(new Date()));
					localStorage.setItem('cs_CMCinfos', JSON.stringify(data));
				});	
			}
			else {
				console.log("Read CMC General Infos");
				cmcInfos = JSON.parse(localStorage.getItem('cs_CMCinfos'));
				dateConvert = convertDate(cmcInfos.last_updated);
				// console.log(cmcInfos);
				$("#lastupdate").html(dateConvert);
				if(currency == "EUR") {
					$("#gl_Vol").html(nFormatter(cmcInfos.total_24h_volume_eur, 4));
					if(cmcInfos.total_24h_volume_eur < 10000000000) {
						$("#cmc_vol").css("background-color", "red");
						$("#cmc_vol").css("color", "white");
					}
					else if(cmcInfos.total_24h_volume_eur >= 10000000000 && cmcInfos.total_24h_volume_eur <= 20000000000) {
						$("#cmc_vol").css("color", "red");
					}
					else if(cmcInfos.total_24h_volume_eur >= 30000000000 && cmcInfos.total_24h_volume_eur < 35000000000) {
						$("#cmc_vol").css("color", "green");
					}
					else if(cmcInfos.total_24h_volume_eur >= 35000000000) {
						$("#cmc_vol").css("background-color", "green");
						$("#cmc_vol").css("color", "white");
					}
					
					$("#gl_MC").html(nFormatter(cmcInfos.total_market_cap_eur, 4));
					if(cmcInfos.total_market_cap_eur < 100000000000) {
						$("#cmc_mc").css("background-color", "red");
						$("#cmc_mc").css("color", "white");
					}
					else if(cmcInfos.total_market_cap_eur >= 100000000000 && cmcInfos.total_market_cap_eur <= 200000000000) {
						// $("#cmc_mc").css("background-color", "green");
						$("#cmc_mc").css("color", "red");
					}
					else if(cmcInfos.total_market_cap_eur >= 300000000000 && cmcInfos.total_market_cap_eur < 350000000000) {
						// $("#cmc_mc").css("background-color", "green");
						$("#cmc_mc").css("color", "green");
					}
					else if(cmcInfos.total_market_cap_eur >= 350000000000) {
						$("#cmc_mc").css("background-color", "green");
						$("#cmc_mc").css("color", "white");
					}
				}
				if(currency == "USD"){
					$("#gl_MC").html(nFormatter(cmcInfos.total_market_cap_usd, 4));
					$("#gl_Vol").html(nFormatter(cmcInfos.total_24h_volume_usd, 4));
				}
				if(currency == "ETH"){
					$("#gl_MC").html(nFormatter(cmcInfos.total_market_cap_eth, 4));
					$("#gl_Vol").html(nFormatter(cmcInfos.total_24h_volume_eth, 4));
				}
				if(currency == "LTC"){
					$("#gl_MC").html(nFormatter(cmcInfos.total_market_cap_ltc, 4));
					$("#gl_Vol").html(nFormatter(cmcInfos.total_24h_volume_ltc, 4));
				}
				if(currency == "NEO"){
					$("#gl_MC").html(nFormatter(cmcInfos.total_market_cap_neo, 4));
					$("#gl_Vol").html(nFormatter(cmcInfos.total_24h_volume_neo, 4));
				}
				
				$("#curr_symb1").html(currencySym);
				$("#curr_symb2").html(currencySym);
				$("#curr_symb3").html(currencySym);
				

				if(cmcInfos.bitcoin_percentage_of_market_cap < 10) {
					$("#cmc_dom").css("background-color", "red");
					$("#cmc_dom").css("color", "white");
				}
				else if(cmcInfos.bitcoin_percentage_of_market_cap >= 10 && cmcInfos.bitcoin_percentage_of_market_cap <= 30) {
					$("#gl_BTCdom").css("color", "red");
				}
				else if(cmcInfos.bitcoin_percentage_of_market_cap >= 30 && cmcInfos.bitcoin_percentage_of_market_cap < 60) {
					$("#gl_BTCdom").css("color", "green");
				}
				else if(cmcInfos.bitcoin_percentage_of_market_cap >= 60) {
					$("#cmc_dom").css("background-color", "red");
					$("#cmc_dom").css("color", "white");
				}
				

				// if(cmcInfos.bitcoin_percentage_of_market_cap > 50) { 
					// $("#gl_BTCdom").css("color", "red"); 
				// }
				// else { 
					// $("#gl_BTCdom").css("color", "green"); 
				// }
				
				$("#gl_BTCdom").html(cmcInfos.bitcoin_percentage_of_market_cap);
			}
			// var dateConvert = convertDate(cmcInfos.last_updated);

		}
	}

	function GenerateTokensInfos() {
		var cells = { };
		$.each(lstTokens, function(key, value) {
			var tokenName = value[0];
			if(value[1] == "coinmarketcap") {
				tokenInfo_CoinMarketCap(tokenName, value[2], parseFloat(value[4]), value[3]);
			}
			else {
				tokenInfo_IDEXmarket(tokenName, value[2], parseFloat(value[4]), value[3]);
			}
		});
		return cells;
	}

	function GenerateCoinsInfos_offline() {
		var cells = { };
		var nbCoins = smallListCoins.length;
		sortTokens(smallListCoins, indexItem, indexOrder);
		$.each(smallListCoins, function(key, value) {
			// console.log(key + " : " + value[1]);
			if(value != null) {
				var objCoin = lstGoodCoins[value[1]];
				tokenInfo_CoinMarketCap_offline(value[0], objCoin);
			}
		});
		console.log("Nb Coins : "+nbCoins);
		return cells;
	}

	function GenerateForkDeltaTokensInfos_offline() {
		var cells = { };
		// console.log(lstGoodTokens);
		var nbCoins = lstForkDeltaTokens.length;
		$.each(lstForkDeltaTokens, function(key, value) {
			// console.log(key + " : " + value[1]);
			// console.log(value);
			if(value != null) {
				// var objCoin = lstForkDeltaTokens[value[1]];
				tokenInfo_ForkDelta_offline(value[0], value);
			}
		});
		console.log("Nb ForkDelta Tokens : "+nbCoins);
		return cells;
	}

	function GenerateUnknownTokensInfos_offline() {
		var cells = { };
		// console.log(lstGoodTokens);
		var nbCoins = unkTokens.length;
		$.each(unkTokens, function(key, value) {
			// console.log(key + " : " + value[1]);
			// console.log(value);
			if(value != null) {
				// var objCoin = lstForkDeltaTokens[value[1]];
				tokenInfo_Unknown_offline(value[0], value);
			}
		});
		console.log("Nb Unknown Tokens : "+nbCoins);
		return cells;
	}

	function GenerateTokensInfos_offline() {
		var cells = { };
		// console.log(lstGoodTokens);
		var nbCoins = smallListTokens.length;
		sortTokens(smallListTokens, indexItem, indexOrder);
		$.each(smallListTokens, function(key, value) {
			// console.log(key + " : " + value[1]);
			if(value != null) {
				var objCoin = lstGoodTokens[value[1]];
				tokenInfo_CoinMarketCap_offline(value[0], objCoin);
			}
		});
		console.log("Nb CMC Tokens : "+nbCoins);
		return cells;
	}

	function GenerateCoinsInfos() {
		var cells = { };
		var nbCoins = 0;
		$.each(lstCoins, function(key, value) {
			var coinName = value[0].toLowerCase();
			if(value[1] == "coinmarketcap") {
				if(!configScreener.localWallet) {
					if((lstAllTokensCMC.filter(p => (p.id).toLowerCase() == coinName)).length > 0) {
						var indexToken = lstAllTokensCMC.findIndex(p => (p.id).toLowerCase() == coinName);
						var token = lstAllTokensCMC.filter(p => (p.id).toLowerCase() == coinName);
						var totalTokens = parseFloat(value[4]) * token[0].price_eur;
						lstGoodCoins[token[0].rank] = [token[0].id, token[0].symbol, token[0].rank, token[0].price_btc, token[0]["percent_change_24h"], token[0].market_cap_usd, token[0]["24h_volume_usd"], parseFloat(value[4]), token[0].name, token[0].price_usd, token[0].price_eur, "Not a token"] ;
						smallListCoins.push([(token[0].id).toUpperCase(), parseInt(token[0].rank), parseFloat(token[0]["percent_change_24h"]), totalTokens]);
					}
					else {
						unkTokens.push([tokenName, tokenName, 0, 0, 0, 0, 0, ""]);
					}							
				}
				else if(!func_GetWallet.includes(value[0])) {
					if((lstAllTokensCMC.filter(p => (p.id).toLowerCase() == coinName)).length > 0) {
						var indexToken = lstAllTokensCMC.findIndex(p => (p.id).toLowerCase() == coinName);
						var token = lstAllTokensCMC.filter(p => (p.id).toLowerCase() == coinName);
						var totalTokens = parseFloat(value[4]) * token[0].price_eur;
						lstGoodCoins[token[0].rank] = [token[0].id, token[0].symbol, token[0].rank, token[0].price_btc, token[0]["percent_change_24h"], token[0].market_cap_usd, token[0]["24h_volume_usd"], parseFloat(value[4]), token[0].name, token[0].price_usd, token[0].price_eur, "Not a token"] ;
						smallListCoins.push([(token[0].id).toUpperCase(), parseInt(token[0].rank), parseFloat(token[0]["percent_change_24h"]), totalTokens]);
					}
					else {
						unkTokens.push([tokenName, tokenName, 0, 0, 0, 0, 0, ""]);
					}							
				}
			}
			else {
				// tokenInfo_IDEXmarket(coinName, value[2], parseFloat(value[4]), value[3]);
			}
		});
		$.each(lstTokens, function(key, value) {
			var coinName = value[0].toLowerCase();
			if(value[1] == "coinmarketcap") {
				if(!configScreener.localWallet) {
					if((lstAllTokensCMC.filter(p => (p.id).toLowerCase() == coinName)).length > 0) {
						var indexToken = lstAllTokensCMC.findIndex(p => (p.id).toLowerCase() == coinName);
						var token = lstAllTokensCMC.filter(p => (p.id).toLowerCase() == coinName);
						var totalTokens = parseFloat(value[4]) * token[0].price_eur;
						lstGoodTokens[token[0].rank] = [token[0].id, token[0].symbol, token[0].rank, token[0].price_btc, token[0]["percent_change_24h"], token[0].market_cap_usd, token[0]["24h_volume_usd"], parseFloat(value[4]), token[0].name, token[0].price_usd, token[0].price_eur, "0x"] ;
						smallListTokens.push([(token[0].id).toUpperCase(), parseInt(token[0].rank), parseFloat(token[0]["percent_change_24h"]), totalTokens]);
					}
					else {
						unkTokens.push([tokenName, tokenName, 0, 0, 0, 0, 0, ""]);
					}							
				}
				else if(!func_GetWallet.includes(value[0])) {
					if((lstAllTokensCMC.filter(p => (p.id).toLowerCase() == coinName)).length > 0) {
						var indexToken = lstAllTokensCMC.findIndex(p => (p.id).toLowerCase() == coinName);
						var token = lstAllTokensCMC.filter(p => (p.id).toLowerCase() == coinName);
						var totalTokens = parseFloat(value[4]) * token[0].price_eur;
						lstGoodTokens[token[0].rank] = [token[0].id, token[0].symbol, token[0].rank, token[0].price_btc, token[0]["percent_change_24h"], token[0].market_cap_usd, token[0]["24h_volume_usd"], parseFloat(value[4]), token[0].name, token[0].price_usd, token[0].price_eur, "0x"] ;
						smallListTokens.push([(token[0].id).toUpperCase(), parseInt(token[0].rank), parseFloat(token[0]["percent_change_24h"]), totalTokens]);
					}
					else {
						unkTokens.push([tokenName, tokenName, 0, 0, 0, 0, 0, ""]);
					}							
				}
			}
			else {
				// tokenInfo_IDEXmarket(coinName, value[2], parseFloat(value[4]), value[3]);
			}
		});
		
		return cells;
	}

	function loadWallet_online() {
		$.each(lstCoins, function(key, value) {
			if(value[0] == "NEO") {
				getWallet_NEO(value[5]);
			}
			if(value[0] == "ARCTICCOIN") {
				getWallet_ArcTic(value[5]);
			}
		});
	}

	function changeWalletBalance() {
		walletBalances.EUR = walletBalance;
		var last_walletBalances;
		if (localStorage.getItem("cs_balances") === null) {
			localStorage.setItem('cs_balances', JSON.stringify(walletBalances));
		}
		else {
			last_walletBalances = JSON.parse(localStorage.getItem("cs_balances"));
			gain_loss = walletBalance - parseFloat(last_walletBalances.EUR);
		}
		
		// console.log("wall: "+ walletBalance +" | last: " + last_walletBalances.EUR + " | g/l: " + gain_loss);
	}

	function sortTokens(lst_Tokens, index, order) {
		if(order == "ASC") {
			lst_Tokens.sort(function(a,b){
				return a[index] - b[index];
			});
		}
		else {
			lst_Tokens.sort(function(a,b){
				return b[index] - a[index];
			});
		}
		return lst_Tokens;
	}
	
	function sortChoice(Choice) {
		if(Choice == "Balance") {
			indexItem = 3;
			indexOrder = "DESC";
		}
		else if(Choice == "24H") {
			indexItem = 2;
			indexOrder = "DESC";
		}
		else {
			indexItem = 1;
			indexOrder = "ASC";
		}
		console.log(smallListCoins);
		sortTokens(smallListCoins, indexItem, indexOrder);
		sortTokens(smallListTokens, indexItem, indexOrder);
		console.log(smallListCoins);
		configScreener.viewOrder = Choice;
		localStorage.setItem('cs_configuration', JSON.stringify(configScreener));
		refreshTables();
	}
	
	function verifyForkDelta() {
		var listFDTokens = new Array();
		try {
			$.ajax({
				type: "GET",
				url: "forkdelta.json",
				dataType: "text",
				async: false,
				success: function(data) { 
					// console.log(JSON.parse(data));
					listFDTokens = JSON.parse(data);
				},
				error: function(error) { 

				}
			});
			// var cpt = lstGoodTokens.length;
			
			$.each(listFDTokens, function(key, value) {
				// console.log(value.tokenAddr);
				if((unkTokens.filter(p => p[7] == value.tokenAddr)).length > 0) {
					var indexToken = unkTokens.findIndex(p => p[7] == value.tokenAddr);
					var token = unkTokens.filter(p => p[7] == value.tokenAddr);
					var totalTokens = parseFloat(Number(value.bid)) * token[0][6];
					lstForkDeltaTokens.push([token[0][0], token[0][1], value.quoteVolume, value.baseVolume, value.last, value.ask, 0, parseFloat(token[0][6]), token[0][0], 0, parseFloat(Number(value.bid)), token[0][7]]);
					unkTokens.splice(indexToken, 1);
					// smallListForkDeltaTokens.push([token[0][0], 0, parseFloat(token[0][5]), totalTokens]);
				}
			});
		}
		catch(e) {

		}	
	}
	
	</script>
</body>
</html>